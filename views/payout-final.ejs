<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Import CSS Bootstrap -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <!-- Import custom CSS -->
        <!--<link rel="stylesheet" type="text/css" href="/css/style-product.css">-->
        <link rel="stylesheet" type="text/css" href="/css/style-navbar.css">
        <link rel="stylesheet" type="text/css" href="/css/style-cart.css">
        <link rel="stylesheet" type="text/css" href="/css/style-payout.css">
        <script src="https://js.stripe.com/v3/"></script>
        <title>Hub principal du site</title>
    </head>
 
    <body>
    	<header>
            <% include navbar %>
        </header>

        <main class="bg-light py-5">
            <div class="pt-3">
                <ul class="payout-order list-inline text-center mt-4">
                    <li class="list-inline-item">
                        <a href="/payout-infos">
                            <span class="order">1</span>
                            <span class="label"> Informations </span>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a href="/payout-shipping">
                            <span class="order">2</span>
                            <span class="label"> Livraison </span>
                        </a>
                    </li>
                     <li class="list-inline-item active">
                        <a href="/payout-final">
                            <span class="order">3</span>
                            <span class="label"> Payement </span>
                        </a>
                    </li>
                    <div class="line"></div>
                </ul>
            </div>

    		<div class="container-fluid row m-0 p-0">
    			<div class="payout-left border col-md-8 mt-3 p-3">
                    <div class="p-4 container subscribe">
                        	<span class="title"> Mode de payement </span>
                        	<div class="payment-method px-3 mb-4 border rounded">
                                <div class="row radio-payout py-2">
                                    <div class="radio col-1">
                                        <input type="radio" id="pm2" class="" name="paymentMethod" checked>
                                    </div>
                                    <div class="label col row justify-content-between">
                                    	<div>
                                        	<label for="pm2" class="m-0 ml-3"> Carte Bancaire </label>
                                        </div>
                                        <div class="mr-3">
	                                        <img class="payment-logo" src="/logo_visa.png">
	                                        <img class="payment-logo" src="/logo_mc.svg">
	                                        <img class="payment-logo" src="/logo_amex.svg">
	                                    </div>
                                    </div>
                                </div>

                                 <div class="row card-payment border-top p-3">
                                	<div class="col p-0" id="payment-form">
										<div id="cardNumber"></div>
										<div class="row p-3">
											<div class="col mr-2" id="cardExpiry"></div>
											<div class="col ml-2" id="cardCvc"></div>
										</div>

										<!-- We'll put the error messages in this element -->
										<div class="text-danger text-center" id="card-errors" role="alert"></div>

										<!--<button id="submit">Pay</button>-->
									</div>
                                </div>

                                 <div class="border-bottom"></div>

                                <div class="row radio-payout py-2">
                                    <div class="radio col-1">
                                        <input type="radio" id="pm1" class="" name="paymentMethod">
                                    </div>
                                    <div class="label col">
                                        <label for="pm1" class="m-0">
                                        	<img class="payment-logo-paypal" src="/logo_paypal.png">
                                     	</label>
                                    </div>
                                </div>
                        	</div>

                            <span class="title"> Adresse de facturation </span>
                            <div class="shipping-adress px-3 mb-4 border rounded text-secondary">
                                <div class="row radio-payout py-2">
                                    <div class="radio col-1">
                                        <input type="radio" id="sa1" class="" name="shippingAdress" checked>
                                    </div>
                                    <div class="label col">
                                        <label for="sa1" class="m-0"> Facturer à l'adresse de mon compte </label>
                                    </div>
                                </div>
                                <div class="border-bottom"></div>
                                <div class="row radio-payout py-2">
                                    <div class="radio col-1">
                                        <input type="radio" id="sa2" class="" name="shippingAdress">
                                    </div>
                                    <div class="label col">
                                        <label for="sa2" class="m-0"> Facturer à une autre adresse </label>
                                    </div>
                                </div>

                                <div class="row shipping-adress-new border-top p-3 hide">
                                    <div class="form-group w-100">
                                        <input type="text" placeholder="Adresse" class="form-control" name="adresse">
                                        <div class="invalid-feedback">Veuillez rentrer une adresse valide</div>
                                    </div>
                                    <div class="form-group w-100">
                                        <input type="text" placeholder="N° suite / appartement (optionnel)" class="form-control" name="adresse2">
                                        <div class="invalid-feedback">Veuillez rentrer une adresse valide</div>
                                    </div>
                                    <div class="form-row w-100 m-0 mb-3">
                                        <div class="col p-0 pr-1">
                                            <input type="text" placeholder="Ville" class="form-control" name="city">
                                            <div class="invalid-feedback">Veuillez rentrer une ville valide</div>
                                        </div>
                                        <div class="col p-0 pl-1">
                                            <input type="text" placeholder="Code postal" class="form-control" name="postal-code">
                                            <div class="invalid-feedback">Veuillez rentrer un code valide</div>
                                        </div>
                                    </div>
                                    <div class="form-row w-100 m-0">
                                        <div class="col p-0 pr-1">
                                            <input type="text" placeholder="Région / Etat" class="form-control" name="state">
                                            <div class="invalid-feedback">Veuillez rentrer une région valide</div>
                                        </div>
                                        <div class="col p-0 pl-1">
                                            <input type="text" placeholder="Pays" class="form-control" name="country">
                                            <div class="invalid-feedback">Veuillez rentrer un pays valide</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row justify-content-between">
                                <button type="submit" class="btn btn-secondary m-3 px-4" data-dismiss="">Retour</button>
                                <button type="submit" id="submit-payment" class="btn btn-primary m-3 px-4" data-dismiss="">
                                <div class="paypal-payment hide" id="paypal-button-container"></div>Confirmer</button>
                            </div>
                    </div>
    			</div>
    			
    			<!---------------------------------------------------------------------->

	    		<div class="payout-right col-md-4 mt-3 p-4">
	    			<div class="sticky-top sticky-offset cart-recap">
                        <div class="row">
                            <span class="title col">Récapitulatif</span>
                        </div>
                        <div class="w-100 border-bottom my-3"></div>
                        <div class="row py-3">
                            <span class="title col-5">SOUS-TOTAL</span>
                            <span class="price price-sub-total col text-right">€</span>
                        </div>
                        <div class="row py-3">
                            <span class="title col-5">LIVRAISON</span>
                            <span class="price price-shipping col text-right">€</span>
                        </div>
                        <div class="w-100 border-bottom my-3"></div>
                        <div class="row pb-5">
                            <span class="title total col-5">TOTAL</span>
                            <span class="price price-total col text-right">€</span>
                        </div>
	    			</div>
	    		</div>
	    	</div>
        </main>
    </body>

<!---------------------------- GLOBAL SCRIPTS -------------------------------->
<script>
	$( "input[type=radio][name=shippingAdress]" ).change(function() {
	    if ($(this).attr('id') == 'sa1') {
	        $('.shipping-adress-new').addClass('hide');
	    } else {
	        $('.shipping-adress-new').removeClass('hide');
	    }
	});
	$( "input[type=radio][name=paymentMethod]" ).change(function() {
	    if ($(this).attr('id') == 'pm1') {
	        $('.paypal-payment').removeClass('hide');
	        $('.card-payment').addClass('hide');
	    } else {
	        $('.card-payment').removeClass('hide');
	        $('.paypal-payment').addClass('hide');
	    }
	});

	/* ================================ STRIPE ================================== */

	var stripe = Stripe('pk_test_yPzxYfltlnyWe55PR7jjw4PX00vkHy4ywN');
	// Create an instance of Elements.
	var elements = stripe.elements();

	// Custom styling can be passed to options when creating an Element.
	// (Note that this demo uses a wider set of styles than the guide below.)
	var style = {
		base: {
			color: "#32325d",
		}
	};

	var cardNumber = elements.create("cardNumber", { style: style, showIcon: true });
	var cardExpiry = elements.create("cardExpiry", { style: style });
	var cardCvc = elements.create("cardCvc", { style: style });
	cardNumber.mount("#cardNumber");
	cardExpiry.mount("#cardExpiry");
	cardCvc.mount("#cardCvc");

	cardNumber.addEventListener('change', function(event) {
		var displayError = document.getElementById('card-errors');
		if (event.error) {
			displayError.textContent = event.error.message;
		} else {
			displayError.textContent = '';
		}
	});
	cardExpiry.addEventListener('change', function(event) {
		var displayError = document.getElementById('card-errors');
		if (event.error) {
			displayError.textContent = event.error.message;
		} else {
			displayError.textContent = '';
		}
	});
	cardCvc.addEventListener('change', function(event) {
		var displayError = document.getElementById('card-errors');
		if (event.error) {
			displayError.textContent = event.error.message;
		} else {
			displayError.textContent = '';
		}
	});

	/* ============================== SUBMIT ==================================== */

	$('#submit-payment').click( function () {
		console.log("submition")
		var paymentMethod = $("input[type=radio][name=paymentMethod]:checked").attr("id");

		// if payment -> card (Stripe)
		if (paymentMethod == 'pm2') {
			//ev.preventDefault();
			stripe.confirmCardPayment('<%= client_secret %>', {
				payment_method: {
					type: 'card',
				    card: elements.getElement('cardNumber'),
					billing_details: {
						address: {
							city: 'Plaisir',
							country: 'FR',
							line1: '28rue des petits ponts',
							line2: '',
							postal_code: '78300',
							state: 'Yvelines'
						},
						email: "jenny@example.com",
						name: 'François Dupont',
						phone: "+15555555555"
					},
				}
			}).then( function(result) {
				if (result.error) {
					// Show error to your customer (e.g., insufficient funds)
					console.log(result.error.message);
				} else {
					// The payment has been processed!
					if (result.paymentIntent.status === 'succeeded') {
						console.log('success')
						// Show a success message to your customer
						// There's a risk of the customer closing the window before callback
						// execution. Set up a webhook or plugin to listen for the
						// payment_intent.succeeded event that handles any business critical
						// post-payment actions.
					}
				}
			});
		} 

		// si payement -> paypal
		else if (paymentMethod == 'pm1') {
			return 0;
		}
	});
</script>

<!-------------------------------- PAYPAL SCRIPTS ---------------------------->
<script src="https://www.paypal.com/sdk/js?client-id=AdLbFjUFxlf2azMI6_BTzfiXtZNdnoKBW5yRoexLDY6DZJFK2Fw6Vd17TahRpzK-QhdGe1_h2xIicuvf&currency=EUR&components=buttons,funding-eligibility"></script>
<script>
	// Set up transaction
	paypal.Buttons({
	    createOrder: function(data, actions) {
  		// This function sets up the details of the transaction, including the amount and line item details.
      		return actions.order.create({
      			intent: "capture",
				purchase_units: [{
					amount: {
						value: '14.99',
						currency_code: 'EUR',
					}
				}],
				payer: {
					name: {
						surname: 'Dupont',
						given_name: 'François',
					},
					email_address: 'gabou@outlook.fr',
					//payer_id: '15',
					/*phone: {
						phone_number: {
							national_number: "06xxxxxx"
						}
					}*/
					address: {
						address_line_1: '173 Drury Lane',
						address_line_2: 'n° appartment suite',
						postal_code: '78370',
						admin_area_2: 'Plaisir',
						admin_area_1: 'Bretagne',
						country_code: 'FR'
					}
				},
				application_context: {
					brand_name: 'Ydogbe',
					shipping_preference: 'NO_SHIPPING',
					/*payment_method: {
						payer_selected:'paypal'
					},*/
					return_url: 'http://192.168.1.18:8080/paypal-success',
					cancel_url: 'http://192.168.1.18:8080/paypal-cancel',
				}
			});
	    },
	    onApprove: function(data, actions) {
      	// This function captures the funds from the transaction.
      		return actions.order.capture().then(function(details) {
	        // This function shows a transaction success message to your buyer.
	        	alert('Transaction completed by ' + details.payer.name.given_name);
	      	});
	    },
	    style: {
		    height: 55,
	  	}
  	})
	// This function displays Smart Payment Buttons on your web page.

	var FUNDING_SOURCES = [paypal.FUNDING.PAYPAL];

	// Loop over each funding source / payment method
	FUNDING_SOURCES.forEach(function(fundingSource) {

	    // Initialize the buttons
	    var button = paypal.Buttons({
	        fundingSource: fundingSource
	    });

	    // Check if the button is eligible
	    if (button.isEligible()) {

	        // Render the standalone button for that funding source
	        button.render('#paypal-button-container');
	    }
	});
</script>